<!-- The following code should appear at the beginning of the first appendix.
(if you have one)
After that, all subsequent sections will be turned into appendices. -->

`r if(knitr:::is_latex_output()) '% begin csasdown appendix'`
`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`

\clearpage

# TIMELINE OF TRADITIONAL LOCALITIES. {#app:first-appendix}
List of localities visited in the traditional component of the sablefish research and assessment surveys from 1988 through 2009. Standardized sets (light blue boxes and half boxes) were conducted in offshore indexing localities from 1988 to 2009. Sablefish were tagged and released (dark blue half boxes) from standardized sets at offshore indexing localities beginning in 1991 and ending in 2007. Offshore tagging localities where only traditional tagging sets (red boxes) occurred were added in 1995 and discontinued in 2008. Mainland Inlet localities where standardized sets (green boxes) were conducted began in 1994 and continued through to 2009. Starting in 2002 (dark green), five standard fishing areas were delineated to ensure the consistency of set positions.

```{r appendixA, , out.width = "440px", out.height = "470px", echo=FALSE, fig.align="center", warning=FALSE}
      img <- paste(figpath,'AppendixA1.png',sep='') 
      knitr::include_graphics(img)
```
\clearpage

# LIST OF SABLEFISH RESEARCH AND ASSESSMENT SURVEYS. {#app:second-appendix}

```{r appendixB, results="asis"}

   survey.trip   <- paste("exec dbo.procRKnitr_SurveyTrips ", yr+1, sep="")
   #trip   <- GetSQLData(survey.trip  ,"Sablefish")     # query SQL Server for trips over time
   #write.table(trip, file = paste(path,'appendixB.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")  
   trip   <-  read.csv(paste(path,'appendixB.csv',sep=''),header=T)
   colnames(trip) <- c( "Year", "Date",      "Vessel",      
                         "Fishing Master",   "Set Count",     "GFBIO Trip id")  # short colnames
   
   kableExtra::kable(trip,
                     booktabs = TRUE, 
                     longtable = T,
                     linesep   = "",
                     format = "latex")  %>%
   kableExtra::kable_styling(font_size = 8) %>%
                     row_spec(0, bold = T)

```
\clearpage

# DATA FORMS OF THE `r yr` AND `r yr+1` SABLEFISH SURVEYS. {#app:third-appendix}

```{r appendixC1,out.width = "390px", out.height = "500px", fig.align="center"}

      if(knitr:::is_latex_output())
         # paper bridge log
         img <-  paste(figpath,'appendix_C1_BridgeLog.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure C.1. Example of a completed bridge log data form used during the `r yr` and `r yr+1` surveys.

\clearpage

```{r AppendixC2,out.width = "390px", out.height = "570px", fig.align="center"}

      if(knitr:::is_latex_output())
         # paper set catch log
         img <-  paste(figpath,'appendix_C2_CatchLog.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure C.2. Example of a completed catch log form used during the `r yr` and `r yr+1` surveys.

\clearpage


```{r AppendixC3,out.width = "400px", out.height = "590px", fig.align="center"}

      if(knitr:::is_latex_output())
         # paper tabular catch log
         img <-  paste(figpath,'appendix_C3_CatchEntryLog.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure C.3. Example of a tabular catch log data entry form transposed from the catch log in Figure C.2. 

\clearpage

```{r AppendixC4,out.width = "460px", out.height = "260px", fig.align="center"}

      if(knitr:::is_latex_output())
         # paper LSM log
         img <-  paste(figpath,'appendix_C4_LSM.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure C.4.  Example of a completed length, sex and maturity (LSM) sampling form used during the `r yr` and `r yr+1` surveys.

```{r AppendixC5,out.width = "460px", out.height = "260px", fig.align="center"}

      if(knitr:::is_latex_output())
         # paper LSM log
         img <-  paste(figpath,'appendix_C5_LSWMO.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure C.5.  Example of a completed length, sex, weight, maturity and otolith (LSWMO) sampling form used during the `r yr` and `r yr+1` surveys.
\clearpage


```{r AppendixC6,out.width = "460px", out.height = "260px", fig.align="left"}

      if(knitr:::is_latex_output())
         # paper rougheye rockfish biological length, sex, maturity sheet
         img <-  paste(figpath,'appendix_C6_LSS.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure C.6.  Example of a length sex species (LSS) form used during the `r yr` and `r yr+1` surveys.

\clearpage

```{r AppendixC7,out.width = "400px", out.height = "580px", fig.align="left"}

      if(knitr:::is_latex_output())
         # paper tagging sheet 
         img <-  paste(figpath,'appendix_C7_tagSheet.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure C.7.  Example of a sablefish tagging form of the type used during the `r yr` and `r yr+1` surveys.

\clearpage

```{r AppendixC8,out.width = "470px", out.height = "288px", fig.align="left"}

      if(knitr:::is_latex_output())
         # paper tag recovery sheet 
         img <-  paste(figpath,'appendix_C8_tagrec.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure C.8.  Example of a sablefish tag recovery form of the type used during the `r yr` and `r yr+1` surveys.

\clearpage


# SET DETAILS `r yr`. {#app:fourth-appendix}
Details of sets completed during the `r yr` survey program (F/V `r boat1`).  Sets are listed by spatial name, set type, depth stratum, start date, end of gear deployment time and duration in minutes. The depth strata for StRS sets include RD~1~ (100-250 fathoms), RD~2~ (250-450 fathoms) and RD~3~ (450-750 fathoms). The depth strata for offshore standardized (OffStd) sets include D0 (50-149 fathoms), D1 (150-249 fathoms), D2 (250-349 fathoms), D3 (350-449 fathoms), D4 (450-549 fathoms) and D5 (550-649 fathoms).  The position data includes the major area, start and end latitude and longitude in degrees decimal minutes. The bottom depths (meters) of the fishing set are listed with the mean bottom depth calculated from recordings at one minute intervals between the start and end of the set. The number of traps fished for each set excludes open traps, while holed or fouled traps have been included.  Sets that successfully deployed a Seabird SBE temperature and pressure recorder are indicated with an 'x'.


```{r appendixD, results="asis"}

   options(knitr.kable.NA = '')  # get rid of NAs

   srvy.sets <-  paste("dbo.procRReport_Survey_SetDetails ", yr,",1,", 157, sep="")
   #srvy.set.details     <-  GetSQLData(srvy.sets,"Sablefish")   # query SQL Server for set details year 1
   #write.table(srvy.set.details, file = paste(path,"appendixD.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
   srvy.set.details   <-  read.csv(paste(path,'appendixD.csv', sep=''), header=T)
   inlet.sets         <-  srvy.set.details[srvy.set.details$set_type=='Inlet',]
   start.inlet        <-  min(inlet.sets$set)
   end.inlet          <-  max(inlet.sets$set)   
   
   latcnt  <-  length(srvy.set.details[, 9])
               for (i in 1:latcnt)
                      { srvy.set.details[i,9]= paste(srvy.set.details[i,9],'° ', srvy.set.details[i,10],"'N",sep="")  }  # add degree N
   latcnt  <-  length(srvy.set.details[,11])
               for (i in 1:latcnt)
                      { srvy.set.details[i,11]=paste(srvy.set.details[i,11],'° ', srvy.set.details[i,12],"'W",sep="") }  # add degree W
   latcnt  <-  length(srvy.set.details[,13])
               for (i in 1:latcnt)
                      { srvy.set.details[i,13]=paste(srvy.set.details[i,13],'° ', srvy.set.details[i,14],"'N",sep="") }
   latcnt<-length(srvy.set.details[,15])
               for (i in 1:latcnt)
                      { srvy.set.details[i,15]=paste(srvy.set.details[i,15],'° ', srvy.set.details[i,16],"'W",sep="") }
   
   srvy.set.details  <-  srvy.set.details[,c(-10)]
   srvy.set.details  <-  srvy.set.details[,c(-11)]
   srvy.set.details  <-  srvy.set.details[,c(-12)]
   srvy.set.details  <-  srvy.set.details[,c(-13)]
   srvy.set.details  <-  srvy.set.details[,c(-20)]
   srvy.set.details  <-  srvy.set.details[,c(-18,-19)]
   
   srvy.set.details$spatial_stratum <- gsub('Langara Island-North Frederick','Langara Is.-N. Frederick',srvy.set.details$spatial_stratum)
   srvy.set.details$spatial_stratum <- gsub('Portland','Portland Inlet',srvy.set.details$spatial_stratum)
   srvy.set.details$spatial_stratum <- gsub('Finlayson','Finlayson Channel',srvy.set.details$spatial_stratum)   
   srvy.set.details$spatial_stratum <- gsub('Dean/Burke','Dean/Burke Channel',srvy.set.details$spatial_stratum)    
   
   # change the default set type from 'StRS' to Offshore standardized
   srvy.set.details$set_type <- as.character(srvy.set.details$set_type) 
   
   srvy.set.details$set_type[srvy.set.details$depth_stratum == 'D1'] <-  "OffStd"
   srvy.set.details$set_type[srvy.set.details$depth_stratum == 'D2'] <-  "OffStd"
   srvy.set.details$set_type[srvy.set.details$depth_stratum == 'D3'] <-  "OffStd"
   srvy.set.details$set_type[srvy.set.details$depth_stratum == 'D4'] <-  "OffStd"   
   srvy.set.details$set_type[srvy.set.details$depth_stratum == 'D5'] <-  "OffStd"
   srvy.set.details$set_type[srvy.set.details$set==156] <-  "Explore"
   srvy.set.details$set_type[srvy.set.details$set==157] <-  "Explore"
   srvy.set.details$spatial_stratum[srvy.set.details$set==156] <-  "Porcher Peninsula"  # unique to 2008
   srvy.set.details$spatial_stratum[srvy.set.details$set==157] <-  "Goshen Island"      # unique to 2008
   
   srvy.set.details <-  srvy.set.details[, c(1,2,3,4,5,6,7,8,9,11,10,12,13,14,15,16,17)]  #reorder table

   colnames(srvy.set.details) <- c( "Spatial Stratum", "Set",      "Type",      
                         "Depth Stratum",   "Start Date",     "End Deploy", 
                         "Duration (min)",  "Major Area", 
                         "Start", "End", 
                         "Start", "End", 
                         "Start", "End",    "Mean", 
                         "Traps Fished",    "SBE 39")  # short colnames
   
 
   kableExtra::kable(srvy.set.details,
                    booktabs  = TRUE, 
                    longtable = T,
                    linesep   = "",
                    format    = "latex") %>%
   kableExtra::kable_styling(font_size = 7, latex_options = "repeat_header",
               repeat_header_text = "continued.", repeat_header_method = "replace") %>%
   kableExtra::landscape() %>%
      
   add_header_above(c(" "= 8,"Latitude"=2, "Longitude"=2, "Depth (m)" = 3 ), bold = TRUE) %>% 

   row_spec(0, bold = TRUE) %>%      
   column_spec(1,width    = "2.7cm") %>%  # set spacing on columns to fit
   column_spec(2,width    = "0.5cm") %>%  # set
   column_spec(3,width    = "0.4cm") %>%  # type
   column_spec(4,width    = "1.3cm") %>%  # depth
   column_spec(5,width    = "0.9cm") %>%  # date
   column_spec(6,width    = "0.9cm") %>%  # time      
   column_spec(7,width    = "0.7cm") %>%  # duration
   column_spec(8,width    = "0.5cm") %>%  # area
   column_spec(9,width    = "1.1cm") %>%  # start lat
   column_spec(10,width   = "1.1cm") %>%  # end lat
   column_spec(11,width   = "1.4cm") %>%  # start long
   column_spec(12,width   = "1.4cm") %>%  # end long
   column_spec(13,width   = "0.5cm") %>%  
   column_spec(14,width   = "0.5cm") %>%      
   column_spec(15,width   = "0.5cm") %>%  
   column_spec(16,width   = "0.6cm") %>%  
   column_spec(17,width   = "0.4cm") %>% 
 
   sub("\\caption\\[\\]\\{\\}", "\\caption*{}", .)  
``` 

\clearpage

# SET DETAILS `r yr+1`. {#app:fifth-appendix} 

Details of sets completed during the `r yr+1` survey program (F/V `r boat2`).  Sets are listed by stratum/inlet name, set type, depth stratum, start date, end of gear deployment time and duration in minutes. The depth strata for StRS sets include RD~1~ (100-250 fathoms), RD~2~ (250-450 fathoms) and RD~3~ (450-750 fathoms). The depth strata for offshore standardized (OffStd) sets include D0 (50-149 fathoms), D1 (150-249 fathoms), D2 (250-349 fathoms), D3 (350-449 fathoms), D4 (450-549 fathoms) and D5 (550-649 fathoms).The position data includes the major area,  start and end latitude and longitude in degrees decimal minutes. The bottom depths (meters) of the fishing set are listed with the mean bottom depth calculated from recordings at one minute intervals between the start and end of the set. The number of traps fished for each set excludes open traps, while holed or fouled traps have been included.  Sets that successfully deployed a Seabird SBE temperature and pressure recorder are indicated with an 'x'.

```{r appendixE, echo=FALSE}
   options(knitr.kable.NA = '')  # get rid of NAs
   srvy.sets <-  paste("dbo.procRReport_Survey_SetDetails ", yr+1,", 1,", 155, sep="")
   #srvy.set.details     <-  GetSQLData(srvy.sets,"Sablefish")   # query SQL Server for set details year 1
   #write.table(srvy.set.details, file = paste(path,"appendixE.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
   srvy.set.details2   <-  read.csv(paste(path,'appendixE.csv',sep=''),header=T)
   inlet.sets2         <-  srvy.set.details2[srvy.set.details2$set_type=='Inlet',]
   start.inlet2        <-  min(inlet.sets2$set)
   end.inlet2          <-  max(inlet.sets2$set)   
   
   latcnt  <-  length(srvy.set.details2[, 9])
               for (i in 1:latcnt)
                      { srvy.set.details2[i,9]= paste(srvy.set.details2[i,9],'° ', srvy.set.details2[i,10], "'N",sep="")  }
   latcnt  <-  length(srvy.set.details2[,11])
               for (i in 1:latcnt)
                      { srvy.set.details2[i,11]=paste(srvy.set.details2[i,11],'° ', srvy.set.details2[i,12],"'W",sep="") }
   latcnt  <-  length(srvy.set.details2[,13])
               for (i in 1:latcnt)
                      { srvy.set.details2[i,13]=paste(srvy.set.details2[i,13],'° ', srvy.set.details2[i,14],"'N",sep="") }
   latcnt  <-  length(srvy.set.details2[,15])
               for (i in 1:latcnt)
                      { srvy.set.details2[i,15]=paste(srvy.set.details2[i,15],'° ', srvy.set.details2[i,16],"'W",sep="") }
   
   srvy.set.details2  <-  srvy.set.details2[,c(-10)]
   srvy.set.details2  <-  srvy.set.details2[,c(-11)]
   srvy.set.details2  <-  srvy.set.details2[,c(-12)]
   srvy.set.details2  <-  srvy.set.details2[,c(-13)]
   srvy.set.details2  <-  srvy.set.details2[,c(-20)]
   srvy.set.details2  <-  srvy.set.details2[,c(-18,-19)]
   
   srvy.set.details2$spatial_stratum <- gsub('Langara Island-North Frederick','Langara Is.-N. Frederick',srvy.set.details2$spatial_stratum)
   srvy.set.details2$spatial_stratum <- gsub('Portland','Portland Inlet',srvy.set.details2$spatial_stratum)
   srvy.set.details2$spatial_stratum <- gsub('Finlayson','Finlayson Channel',srvy.set.details2$spatial_stratum)   
   srvy.set.details2$spatial_stratum <- gsub('Dean/Burke','Dean/Burke Channel',srvy.set.details2$spatial_stratum) 
   
   # change the default set type from 'StRS' to Offshore standardized
   srvy.set.details2$set_type <- as.character(srvy.set.details2$set_type) 
   
   srvy.set.details2$set_type[srvy.set.details2$depth_stratum == 'D1'] <-  "OffStd"
   srvy.set.details2$set_type[srvy.set.details2$depth_stratum == 'D2'] <-  "OffStd"
   srvy.set.details2$set_type[srvy.set.details2$depth_stratum == 'D3'] <-  "OffStd"
   srvy.set.details2$set_type[srvy.set.details2$depth_stratum == 'D4'] <-  "OffStd"   
   srvy.set.details2$set_type[srvy.set.details2$depth_stratum == 'D5'] <-  "OffStd"

   srvy.set.details2 <-  srvy.set.details2[, c(1,2,3,4,5,6,7,8,9,11,10,12,13,14,15,16,17)]  #reorder table
    
   colnames(srvy.set.details2) <- c( "Spatial Stratum", "Set",      "Type",      
                         "Depth Stratum",   "Start Date",     "End Deploy", 
                         "Duration (min)",  "Major Area", 
                         "Start", "End", 
                         "Start", "End", 
                         "Start", "End",    "Mean", 
                         "Traps Fished",    "SBE 39")  # short colnames
   
   #  head(srvy.set.details2)
    
   kableExtra::kable(srvy.set.details2,
                    booktabs = TRUE, 
                    longtable = T,
                    linesep   = "",
                    format = "latex") %>%
   kableExtra::kable_styling(font_size = 7, latex_options = "repeat_header", 
               repeat_header_text = "continued.", repeat_header_method = "replace") %>%
   kableExtra::landscape() %>%
      
   add_header_above(c(" "= 8,"Latitude"=2, "Longitude"=2, "Depth (m)" = 3 ), bold = TRUE) %>% 

   row_spec(0, bold = TRUE) %>%      
   column_spec(1,width    = "2.7cm") %>%  # set spacing on columns to fit
   column_spec(2,width    = "0.5cm") %>%  # set
   column_spec(3,width    = "0.4cm") %>%  # type
   column_spec(4,width    = "1.3cm") %>%  # depth
   column_spec(5,width    = "0.9cm") %>%  # date
   column_spec(6,width    = "0.9cm") %>%  # time      
   column_spec(7,width    = "0.7cm") %>%  # duration
   column_spec(8,width    = "0.5cm") %>%  # area
   column_spec(9,width    = "1.1cm") %>%  # start lat
   column_spec(10,width   = "1.1cm") %>%  # end lat
   column_spec(11,width   = "1.4cm") %>%  # start long
   column_spec(12,width   = "1.4cm") %>%  # end long
   column_spec(13,width   = "0.5cm") %>%  
   column_spec(14,width   = "0.5cm") %>%      
   column_spec(15,width   = "0.5cm") %>%  
   column_spec(16,width   = "0.6cm") %>%  
   column_spec(17,width   = "0.4cm") %>%  
   
   sub("\\caption\\[\\]\\{\\}", "\\caption*{}", .)      

``` 
\clearpage

# SUMMARY OF BASKET USE BY TRAP `r yr`. {#app:sixth-appendix} 

Summary of the basket use by trap number for sets during the `r yr` sablefish survey. Sets that did not retain sablefish are not listed. Set numbers highlighted in grey represent standardized sets at offshore indexing localities, set numbers highlighted in green represent standardized sets at mainland inlet localities and those in blue represent exploratory sets. All other sets are of the StRS type. The fate of the sablefish catch for each set and trap is indicated using the following abbreviations:  D = Discarded after weighing (released at sea), A = Sampled for LSMWO, B = Sampled for LSM, T = Tagged and released, F= Frames, NA = No sablefish catch/trap missing. 

```{r appendixF, echo=FALSE}
   # Sablefish.dbo.procRReport_Survey_TrapUse procedure pulls data from table dbo.GFBIO_TRAPS_USE created by procedure 
   # Sablefish.dbo.Build_BIO_Sablefish_Tables
  
   options(knitr.kable.NA = '')
   trapUse       <- paste("dbo.procRReport_Survey_TrapUse ",yr,",1,",157, sep="")
   #trap.Usage    <- GetSQLData(trapUse,"Sablefish")  # query SQL Server for basket use on each trap year 1
   #write.table(trap.Usage , file = paste(path,"appendixF.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
   trap.Usage    <-  read.csv(paste(path,'appendixF.csv',sep=''),header=T)
   
   
    #prep images
    trap.set         <-  srvy.set.details[ ,c(-1,-4:-24), ]
    #addition        <-  c(156,"explore")
    #trap.set        <-  rbind(trap.set,addition)
    names(trap.set)  <-  c("surveyset","Type")
     
    trap.set$count   <- 100
    trap.set         <- trap.set %>%  # set background color
                         mutate(get.color = ifelse(Type %in% c("OffStd") , "gray",  "white"))
    trap.set$get.color[trap.set$Type=='Inlet']    <- "light green"
    trap.set$get.color[trap.set$Type=='Explore']  <- "light blue"
    trap.set$get.color[trap.set$Type=='OffStd']   <- "gray"
    # tail(trap.set)
    
     w   <-  trap.set %>%
     group_by(surveyset) %>%
     do({
       p <- ggplot(., aes(y = count, x = 1, label=.$surveyset)) + 
              geom_bar(stat="identity", color="white",fill=.$get.color) +
                 ylim(0, 100) +
                 theme_void() +
                 geom_text(size=8,vjust = 1.3)
      #ggsave(p, filename = paste0("sets_", unique(.$surveyset), ".png"), width = 1.2, height = 0.5)  # save time comment out
      invisible(.) })

   trap.Usage  <- trap.Usage [,c(-1)]        # delete trip_id
   trap.Usage  <- trap.Usage [,c(-27,-28)]   # delete Trap 26, 27 if needed
   
   trap.Usage    <- dplyr::mutate(trap.Usage, A  = rowSums(trap.Usage == "A", na.rm = TRUE))  # add up A's
   trap.Usage    <- dplyr::mutate(trap.Usage, AF = rowSums(trap.Usage == "A,F", na.rm = TRUE)) 
   trap.Usage$A2 <- trap.Usage$A + trap.Usage$AF
   
   trap.Usage   <- dplyr::mutate(trap.Usage, B  = rowSums(trap.Usage == "B", na.rm = TRUE))  # add up B's  
   trap.Usage   <- dplyr::mutate(trap.Usage, BF = rowSums(trap.Usage == "B,F", na.rm = TRUE))  
   trap.Usage$B2 <- trap.Usage$B + trap.Usage$BF    
   
   trap.Usage   <- dplyr::mutate(trap.Usage, D  = rowSums(trap.Usage == "D", na.rm = TRUE))  # add up D's 
   trap.Usage   <- dplyr::mutate(trap.Usage, DF = rowSums(trap.Usage == "D,F", na.rm = TRUE))  
   trap.Usage$D2 <- trap.Usage$D + trap.Usage$DF 
   
   trap.Usage   <- dplyr::mutate(trap.Usage, T = rowSums(trap.Usage == "T", na.rm = TRUE))  # add up T's
   trap.Usage   <- dplyr::mutate(trap.Usage, TF = rowSums(trap.Usage == "T,F", na.rm = TRUE))  
   trap.Usage$T2 <- trap.Usage$T + trap.Usage$TF  
   
   trap.Usage  <- dplyr::mutate(trap.Usage, N = rowSums(trap.Usage == "" , na.rm = TRUE))  # add up Nulls 
   trap.Usage    <- trap.Usage [,c(-27,-28,-30,-31,-33,-34,-36,-37)]  # trim unneccessary columns
   
   # Part II, add sparkline in table 
   
   # add in sparkline 
   trap.Usage  <- trap.Usage  %>%    
                  mutate(Survey.set = paste0("\\raisebox{-.28\\height} {\\includegraphics[width=0.8cm]{sets_",Set,".png}}") ) 
   trap.Usage  <- trap.Usage[, c(32,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31)]  #reorder table
   #new.table <- trap.Usage[, c(27,28,29,30,31)]  # check to see if rows add up to 25
   #new.table$summ  <- rowSums(new.table)

   names(trap.Usage)  <-  c("Set","1","2","3","4","5","6","7","8","9",
                                  "10","11","12","13","14","15","16","17",
                                  "18","19","20","21","22","23","24","25",
                                  "A","B","D","T","-")

   kableExtra::kable(trap.Usage,
                     booktabs = TRUE, 
                     longtable = T,
                     escape = F,        # lets the image show up 
                     linesep   = "",
                     format = "latex") %>%
      
   add_header_above(c(" "= 1,
                      "Trap" = 25,
                      "Total"=5
                      ), bold = TRUE) %>%        
      
   kableExtra::kable_styling(font_size = 6, 
                     latex_options = "repeat_header",
                     repeat_header_text = "continued.", 
                     repeat_header_method = "replace") %>%  
      
   kableExtra::landscape()  %>%
       #row_spec(38:52, color="blue"  )       %>%      # unique inlet rows as blue for 2018
       row_spec(0, bold =  TRUE) %>%
       column_spec(1,width      = "0.8cm") %>%
       column_spec(2,width      = "0.2cm") %>%
       column_spec(3,width      = "0.2cm") %>%
       column_spec(4,width      = "0.2cm") %>%
       column_spec(5,width      = "0.2cm") %>%
       column_spec(6,width      = "0.2cm") %>%
       column_spec(7,width      = "0.2cm") %>%
       column_spec(8,width      = "0.2cm") %>%   
       column_spec(9,width      = "0.2cm") %>%   
       column_spec(10,width     = "0.2cm") %>%
       column_spec(11,width     = "0.2cm") %>%
       column_spec(12,width     = "0.2cm") %>%
       column_spec(13,width     = "0.2cm") %>%
       column_spec(14,width     = "0.2cm") %>%
       column_spec(15,width     = "0.2cm") %>%
       column_spec(16,width     = "0.2cm") %>%
       column_spec(17,width     = "0.2cm") %>%
       column_spec(18,width     = "0.2cm") %>%
       column_spec(19,width     = "0.2cm") %>%
       column_spec(20,width     = "0.2cm") %>%
       column_spec(21,width     = "0.2cm") %>%  
       column_spec(22,width     = "0.2cm") %>% 
       column_spec(23,width     = "0.2cm") %>%       
       column_spec(24,width     = "0.2cm") %>% 
       column_spec(25,width     = "0.2cm") %>%
       column_spec(26,width     = "0.2cm") %>%      
       column_spec(27,width     = "0.2cm") %>% 
       column_spec(28,width     = "0.2cm") %>%
       column_spec(29,width     = "0.2cm") %>%
       column_spec(30,width     = "0.2cm") %>%      
       column_spec(31,width     = "0.2cm")
```
\clearpage

# SUMMARY OF BASKET USE BY TRAP `r yr+1`. {#app:seventh-appendix} 

Summary of the basket use by trap number for sets during the `r yr+1` sablefish survey. Set numbers highlighted in blue represent exploratory sets and set numbers highlighted in green represent standardized sets at mainland inlet localities. All other sets are of the StRS type. The fate of the sablefish catch for each set and trap is indicated using the following abbreviations:  D = Discarded after weighing (released at sea), A = Sampled for LSMWO, T = Tagged and released, F= Frames, NA = No sablefish catch/trap missing. 


```{r appendixG, echo=FALSE}
   # Sablefish.dbo.procRReport_Survey_TrapUse procedure pulls data from table dbo.GFBIO_TRAPS_USE created by procedure 
   # Sablefish.dbo.Build_BIO_Sablefish_Tables
   options(knitr.kable.NA = '')

   trapUse2       <- paste("dbo.procRReport_Survey_TrapUse ",yr+1,",1,",155, sep="")
   #trap.Usage2    <- GetSQLData(trapUse2,"Sablefish")  # query SQL Server for basket use on each trap year 1
   #write.table(trap.Usage2 , file = paste(path,"appendixG.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
   trap.Usage2    <-  read.csv(paste(path,'appendixG.csv',sep=''),header=T)
   
     #prep images
     trap.set2         <-  srvy.set.details2[ ,c(-1,-4:-24), ]
     names(trap.set2)  <-  c("surveyset","Type")
     
     trap.set2$count   <- 100
     trap.set2         <- trap.set2 %>%  # set background color
                          mutate(get.color = ifelse(Type %in% c("explore") , "light blue",  "white"))
     trap.set2$get.color[trap.set2$Type=='Inlet']  <- "light green"
     trap.set2$get.color[trap.set2$Type=='OffStd']   <- "gray"
     
    
     # extra line to create the total png
     #trap.set2 <- data.frame("surveyset"="Total","Type"="strs","count"=100,"get.color"="white")
     #head(trap.set2)
     
     w   <-  trap.set2 %>%
     group_by(surveyset) %>%
     do({
       p <- ggplot(., aes(y = count, x = 1, label=.$surveyset)) + 
              geom_bar(stat="identity", color="white",fill=.$get.color) +
                 ylim(0, 100) +
                 theme_void() +
                 geom_text(size=8,vjust = 1.3)
      #ggsave(p, filename = paste0("sets2_", unique(.$surveyset), ".png"), width = 1.2, height = 0.5)   # save time comment out
      invisible(.) })
   
   trap.Usage2    <- trap.Usage2 [,c(-1)]    # delete trip_id
   trap.Usage2    <- trap.Usage2 [,c(-28)]   # delete Trap 27, there is one set with 26 traps

   trap.Usage2    <- dplyr::mutate(trap.Usage2, A = rowSums(trap.Usage2 == "A", na.rm = TRUE))  # add up A's
   trap.Usage2    <- dplyr::mutate(trap.Usage2, AF = rowSums(trap.Usage2 == "A,F", na.rm = TRUE)) 
   trap.Usage2$A2 <- trap.Usage2$A + trap.Usage2$AF
   
   trap.Usage2    <- dplyr::mutate(trap.Usage2, D = rowSums(trap.Usage2 == "D", na.rm = TRUE))  # add up D's     
   trap.Usage2    <- dplyr::mutate(trap.Usage2, DF = rowSums(trap.Usage2 == "D,F", na.rm = TRUE))  
   trap.Usage2$D2 <- trap.Usage2$D + trap.Usage2$DF  
   
   trap.Usage2    <- dplyr::mutate(trap.Usage2, T = rowSums(trap.Usage2 == "T", na.rm = TRUE))  # add up T's
   trap.Usage2    <- dplyr::mutate(trap.Usage2, TF = rowSums(trap.Usage2 == "T,F", na.rm = TRUE))  
   trap.Usage2$T2 <- trap.Usage2$T + trap.Usage2$TF     
   
   trap.Usage2    <- dplyr::mutate(trap.Usage2, N = rowSums(trap.Usage2 == "" , na.rm = TRUE))  # add up Nulls
   trap.Usage2$N  <- trap.Usage2$N-1
   #trap.Usage[4,37] <- 4  # one case where set 4 had 26 traps set
   
   trap.Usage2    <- trap.Usage2[,c(-28,-29,-31,-32,-34,-35)]  # trim unneccessary columns
   
   
   # head(trap.Usage)
   # Part II, add sparkline in table    
   
   # add in sparkline 
   trap.Usage2  <- trap.Usage2  %>%    
                  mutate(Survey.set= paste0("\\raisebox{-.28\\height} {\\includegraphics[width=0.8cm]{sets2_",Set,".png}}") ) 
   
   trap.Usage2  <- trap.Usage2[, c(32,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31)]  # reorder table
   #new.table <- trap.Usage[, c(28,29,30,31)]  # check to see if rows add up to 25
   #new.table$summ  <- rowSums(new.table)

   names(trap.Usage2)  <-  c("Set","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17",
                                  "18","19","20","21","22","23","24","25","26", "A","D","T","-")

   kableExtra::kable(trap.Usage2,
                     booktabs = TRUE, 
                     longtable = T,
                     escape = F,        # lets the image show up 
                     linesep   = "",
                     format = "latex") %>%

   add_header_above(c(" "= 1,
                      "Trap" = 26,
                      "Total"=4
                      ), bold = TRUE) %>%      
      
   kableExtra::kable_styling(font_size = 6, 
                     full_width = FALSE,        
                     latex_options = "repeat_header",
                     repeat_header_text = "continued.", 
                     repeat_header_method = "replace") %>%
       
   kableExtra::landscape()  %>%
   row_spec(0, bold =  TRUE) %>%
   column_spec(1,width      = "0.8cm") %>%
   column_spec(2,width      = "0.2cm") %>%
   column_spec(3,width      = "0.2cm") %>%
   column_spec(4,width      = "0.2cm") %>%
   column_spec(5,width      = "0.2cm") %>%
   column_spec(6,width      = "0.2cm") %>%
   column_spec(7,width      = "0.2cm") %>%
   column_spec(8,width      = "0.2cm") %>%   
   column_spec(9,width      = "0.2cm") %>%   
   column_spec(10,width     = "0.2cm") %>%
   column_spec(11,width     = "0.2cm") %>%
   column_spec(12,width     = "0.2cm") %>%
   column_spec(13,width     = "0.2cm") %>%
   column_spec(14,width     = "0.2cm") %>%
   column_spec(15,width     = "0.2cm") %>%
   column_spec(16,width     = "0.2cm") %>%
   column_spec(17,width     = "0.2cm") %>%
   column_spec(18,width     = "0.2cm") %>%
   column_spec(19,width     = "0.2cm") %>%
   column_spec(20,width     = "0.2cm") %>%
   column_spec(21,width     = "0.2cm") %>%  
   column_spec(22,width     = "0.2cm") %>% 
   column_spec(23,width     = "0.2cm") %>%       
   column_spec(24,width     = "0.2cm") %>%
   column_spec(25,width     = "0.2cm") %>%
   column_spec(26,width     = "0.2cm") %>%      
   column_spec(27,width     = "0.2cm") %>% 
   column_spec(28,width     = "0.2cm") %>%
   column_spec(29,width     = "0.2cm") %>%
   column_spec(30,width     = "0.2cm") %>%      
   column_spec(31,width     = "0.2cm") 
   
```
\clearpage


```{r appendixHSetUp, warning=FALSE, echo=FALSE, message=FALSE, error=FALSE}
   #library(tidyverse)
   #library(tidyr)
   #library(scales)
   #library(pander)

    trap.count <-paste("select tp.YEAR, fe.TRIP_ID, fe.FE_MAJOR_LEVEL_ID AS SET_ID, fe.FE_SUB_LEVEL_ID AS BECKET, ", 
                       "fe.FE_MINOR_LEVEL_ID AS TRAP, SUM(c.CATCH_COUNT) AS total_count ",
                       "from dbo.GFBIO_TRAP_VW_VW AS fe INNER JOIN ",
                       "(select YEAR, TRIP_ID from dbo.SURVEY_trips_vw ",
                       " group by YEAR, TRIP_ID) AS tp ON fe.TRIP_ID = tp.TRIP_ID LEFT OUTER JOIN ",
                       " GFBioSQL.dbo.TRAP_SPECS AS ts ON fe.FISHING_EVENT_ID = ts.FISHING_EVENT_ID LEFT OUTER JOIN ",
                       " (select FISHING_EVENT_ID, SUM(CASE WHEN BAIT_LURE_CODE = 15 AND BAIT_METHOD_CODE = 4  ",
                       " then TRPBL_BAIT_AMOUNT ELSE NULL END) AS BAGGED_SQUID, SUM(CASE WHEN BAIT_LURE_CODE = 18 and  ", 
                       " BAIT_METHOD_CODE = 6 THEN TRPBL_BAIT_AMOUNT ELSE NULL END) AS LOOSE_HAKE,  ",
                       " SUM(CASE WHEN (BAIT_LURE_CODE <> 15 AND BAIT_METHOD_CODE <> 4) AND (BAIT_LURE_CODE <> 18 AND  ",
                       " BAIT_METHOD_CODE <> 6) THEN TRPBL_BAIT_AMOUNT ELSE NULL END) AS OTHER_BAIT ",
                       " from GFBioSQL.dbo.TRAP_BAIT_LURE ",
                       " group by FISHING_EVENT_ID) AS bait ON fe.FISHING_EVENT_ID = bait.FISHING_EVENT_ID  ",
                       " LEFT OUTER JOIN ",
                       " (select fec.FISHING_EVENT_ID, GFBioSQL.dbo.CATCH.SPECIES_CODE,  ",
                       " SUM(GFBioSQL.dbo.CATCH.CATCH_WEIGHT) AS CATCH_WEIGHT, SUM(GFBioSQL.dbo.CATCH.CATCH_COUNT) AS CATCH_COUNT,  ",
                       " AVG(ISNULL(GFBioSQL.dbo.CATCH.CATCH_VERIFICATION_CODE, 0)) AS VERIFICATION_METHOD ",
                       " from GFBioSQL.dbo.FISHING_EVENT_CATCH AS fec INNER JOIN ",
                       " GFBioSQL.dbo.CATCH ON fec.CATCH_ID = GFBioSQL.dbo.CATCH.CATCH_ID ",
                       " where (GFBioSQL.dbo.CATCH.SPECIES_CODE = '455') ",
                       " GROUP BY fec.FISHING_EVENT_ID, GFBioSQL.dbo.CATCH.SPECIES_CODE) AS c ON fe.FISHING_EVENT_ID = c.FISHING_EVENT_ID ",
                       " GROUP BY fe.FE_MAJOR_LEVEL_ID, fe.TRIP_ID, tp.YEAR, fe.FE_SUB_LEVEL_ID, fe.FE_MINOR_LEVEL_ID",
                       " having  (tp.YEAR IN (",yr,")) order by SET_ID, BECKET, TRAP",sep="")
    
   #trap.sable1   <- GetSQLData(trap.count,"Sablefish")
   #write.table(trap.sable1, file = paste(path,"appendixHSetUp.csv",sep=''),row.names=FALSE, na="",col.names=TRUE, sep=",")
   trap.sable1  <-  read.csv(paste(path,'appendixHSetUp.csv',sep=''), header=T)
   
   trap.sable <- trap.sable1[,c(-1,-2,-4)] 
   #trap.sable$SET_ID <- as.factor(trap.sable$SET_ID)
   names(trap.sable) <- c("SurveySet","Trap","Value")
   trap.sable[is.na(trap.sable)] <- 0

   #  trap.sableTest  <-  trap.sable[trap.sable$SurveySet == 40,] 
   big.value <- max(trap.sable$Value)

   w<-trap.sable %>%   # create sparkline graphs
     group_by(SurveySet) %>%
     do({
       p <- ggplot(., aes(x = Trap, y = Value)) + 
         geom_area( fill="#6495ED", alpha=0.4) +  
         geom_line(size = 4, color = "blue") +      
         #geom_point(size=15, color="red") + 
         ylim(0, big.value) +
         xlim(0,25) +
         theme_void() 
         #stat_summary(fun.y = max, colour = "red", geom = "point", size = 5)
         #ggsave(p, filename = paste0("fig", unique(.$SurveySet), ".png"), width = 8, height = 1.9)  # mini graphs
         invisible(.) 
     })

```
\clearpage

# SUMMARY OF SABLEFISH BIOLOGICAL DATA `r yr`. {#app:eighth-appendix} 
Specimen counts of biological data collected for sablefish by set, including catch weight in kilograms and numbers of fish.  Details include a tally of specimens recovered, tagged and sampled.  Mean fork lengths for tagged sablefish and sampled male and female sablefish are listed. Set numbers highlighted in grey indicate standardized sets at offshore indexing localities, set numbers highlighted in green indicate standardized sets at mainland inlet localities and those in blue represent exploratory sets. All other sets are of the StRS type.

```{r appendixH, echo=FALSE}
   #  Sablefish.dbo.procReport_Survey_SampleDetails pulls data from table GFBIO_RESEARCH_SAMPLE_DETAILS built by     
   #  procedure Sablefish.dbo.Build_BIO_Sablefish_Tables 

   setcnt1 = 157
   samples           <-  paste("dbo.procReport_Survey_SampleDetails ", yr ,",1,",setcnt1, sep="")
   #surveyspec       <-  GetSQLData(samples,"Sablefish")  # query SQL Server
   #write.table(surveyspec, file = paste(path,"appendixH.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")
   surveyspec        <-  read.csv(paste(path,'appendixH.csv',sep=''),header=T)
   
   additionSet       <-  c(156,0,0,0,0,0,0,0,0,0,0,0,0,0.0,0,0)  # missing set 156 with no catch specific to 2008
   surveyspec        <-  rbind(surveyspec,additionSet)
   surveyspec        <-  arrange(surveyspec,SET)  # order dataframe by set number
   count.row.total   <-  length(surveyspec$SET)
   count.row         <-  length(surveyspec$SET) - 1
   surveyspec$SET[count.row.total] <- "Total"     # add total in last row

   # add in sparkline graph count by trap
   surveyspec <-  surveyspec %>%
                  mutate(Sparkline = paste0("\\raisebox{.22\\height} {\\includegraphics[width=1.9cm]{fig",SET,".png}}") )
      
   surveyspec  <- surveyspec  %>%    
                   mutate(Survey.set= paste0("\\raisebox{-.28\\height} {\\includegraphics[width=0.8cm]{sets_",SET,".png}}") ) 
   
   surveyspec <-  surveyspec[, c(19,2,3,18,4,5,6,7,8,9,10,11,12,13,14,15,16,17)]  #reorder table

   colnames(surveyspec) <- c("", "kg","Count","Count by Trap","Recover-Rerelease", "Sampled", "Released", 
                             "Count", "Mean", "Fork Length", "Sex","Maturity", "Otoliths",
                             "Weight","Count","Proportion Males", "Males", "Females" )
   
   kableExtra::kable(surveyspec,
                     booktabs = TRUE,     
                     longtable = T,
                     escape = F,        # lets the sparkline image show up 
                     linesep   = "",
                     align=rep('r', 18),
                     format.args = list(big.mark = ','),  # add comma for big numbers
                     format = "latex") %>%
      
   add_header_above(c("Set"= 1,
                      "Total Catch" = 3, 
                      "Tagged Fish Counts" = 3,  
                      "Tagged Fork Lengths(mm)" = 2,
                      "Specimen Count"= 6, 
                      "Mean Fork Length(mm)" = 3), bold = TRUE) %>%
      
   kableExtra::kable_styling(font_size = 7.5, 
                     latex_options = "repeat_header",
                     repeat_header_text = "continued.", 
                     repeat_header_method = "replace") %>%     
   
   kableExtra::landscape()  %>%
   row_spec(0, bold = T)  %>%   
   column_spec(1,width    = "0.2cm") %>%  # set
   column_spec(2,width    = "0.6cm") %>%  # kg
   column_spec(3,width    = "0.7cm") %>%  # count
   column_spec(4,width    = "1.4cm") %>%  # sparkline      
   column_spec(5,width    = "0.9cm") %>%  # released recovered
   column_spec(6,width    = "1.0cm") %>%  # deceased and sampled
   column_spec(7,width    = "0.9cm") %>%  # released    
   column_spec(8,width    = "1.5cm") %>%  # count
   column_spec(9,width    = "0.9cm") %>%  # mean
   column_spec(10,width   = "0.7cm") %>%  # fl
   column_spec(11,width   = "0.6cm") %>%  # sex
   column_spec(12,width   = "0.7cm") %>%  # mat
   column_spec(13,width   = "0.7cm") %>%  # oto 
   column_spec(14,width   = "0.6cm") %>%  # wt
   column_spec(15,width   = "0.6cm") %>%  # cnt
   column_spec(16,width   = "1.1cm") %>%  # prop m
   column_spec(17,width   = "0.7cm") %>%  # male         
   column_spec(18,width   = "0.7cm") %>%  # female
   row_spec(count.row.total, bold = T) %>%      
   row_spec(count.row,  hline_after = T)
      
```
\clearpage

```{r appendixISetUp, warning=FALSE, echo=FALSE, message=FALSE, error=FALSE}

 # count sablefish per trap by set and export sparkline mini graph
 trap.count <-paste(   "select tp.YEAR, fe.TRIP_ID, fe.FE_MAJOR_LEVEL_ID AS SET_ID, ",
                       "fe.FE_SUB_LEVEL_ID AS BECKET, ", 
                       "fe.FE_MINOR_LEVEL_ID AS TRAP, ", 
                       "SUM(c.CATCH_COUNT) AS total_count ",
                       "from dbo.GFBIO_TRAP_VW_VW AS fe ", 
                       "INNER JOIN ",
                       "(select YEAR, TRIP_ID from dbo.SURVEY_trips_vw ",
                       " group by YEAR, TRIP_ID) AS tp ON fe.TRIP_ID = tp.TRIP_ID LEFT OUTER JOIN ",
                       " GFBioSQL.dbo.TRAP_SPECS AS ts ON fe.FISHING_EVENT_ID = ts.FISHING_EVENT_ID LEFT OUTER JOIN ",
                       " (select FISHING_EVENT_ID, SUM(CASE WHEN BAIT_LURE_CODE = 15 AND BAIT_METHOD_CODE = 4  ",
                       " then TRPBL_BAIT_AMOUNT ELSE NULL END) AS BAGGED_SQUID, SUM(CASE WHEN BAIT_LURE_CODE = 18 and  ", 
                       " BAIT_METHOD_CODE = 6 THEN TRPBL_BAIT_AMOUNT ELSE NULL END) AS LOOSE_HAKE,  ",
                       " SUM(CASE WHEN (BAIT_LURE_CODE <> 15 AND BAIT_METHOD_CODE <> 4) AND (BAIT_LURE_CODE <> 18 AND  ",
                       " BAIT_METHOD_CODE <> 6) THEN TRPBL_BAIT_AMOUNT ELSE NULL END) AS OTHER_BAIT ",
                       " from GFBioSQL.dbo.TRAP_BAIT_LURE ",
                       " group by FISHING_EVENT_ID) AS bait ON fe.FISHING_EVENT_ID = bait.FISHING_EVENT_ID  ",
                       " LEFT OUTER JOIN ",
                       " (select fec.FISHING_EVENT_ID, GFBioSQL.dbo.CATCH.SPECIES_CODE,  ",
                       " SUM(GFBioSQL.dbo.CATCH.CATCH_WEIGHT) AS CATCH_WEIGHT, SUM(GFBioSQL.dbo.CATCH.CATCH_COUNT) AS CATCH_COUNT,  ",
                       " AVG(ISNULL(GFBioSQL.dbo.CATCH.CATCH_VERIFICATION_CODE, 0)) AS VERIFICATION_METHOD ",
                       " from GFBioSQL.dbo.FISHING_EVENT_CATCH AS fec INNER JOIN ",
                       " GFBioSQL.dbo.CATCH ON fec.CATCH_ID = GFBioSQL.dbo.CATCH.CATCH_ID ",
                       " where (GFBioSQL.dbo.CATCH.SPECIES_CODE = '455') ",
                       " GROUP BY fec.FISHING_EVENT_ID, GFBioSQL.dbo.CATCH.SPECIES_CODE) AS c ON fe.FISHING_EVENT_ID = c.FISHING_EVENT_ID ",
                       " GROUP BY fe.FE_MAJOR_LEVEL_ID, fe.TRIP_ID, tp.YEAR, fe.FE_SUB_LEVEL_ID, fe.FE_MINOR_LEVEL_ID",
                       " having  (tp.YEAR IN (",yr+1,")) order by SET_ID, BECKET, TRAP", sep="")
    
   #trap.sable.cnt   <- GetSQLData(trap.count,"Sablefish")
   #write.table(trap.sable.cnt , file = paste(path,"appendixISetUp.csv",sep=''),row.names=FALSE, na="",col.names=TRUE, sep=",")
   trap.sable.cnt    <-  read.csv(paste(path,'appendixISetUp.csv',sep=''), header=T)

   
   trap.sable <- trap.sable.cnt[,c(-1,-2,-4)] 
   #trap.sable$SET_ID <- as.factor(trap.sable$SET_ID)
   names(trap.sable) <- c("SurveySet","Trap","Value")
   trap.sable[is.na(trap.sable)] <- 0

   #  trap.sableTest  <-  trap.sable[trap.sable$SurveySet == 40,] 
   big.value <- max(trap.sable$Value)

   w<-trap.sable %>%   # create sparkline graphs
      group_by(SurveySet) %>%
      do({
       p <- ggplot(., aes(x = Trap, y = Value)) + 
            geom_area( fill="#6495ED", alpha=0.4) +  # fill area below line
            geom_line(size = 4, color = "blue") +      
            #geom_point(size=15, color="red") + 
            ylim(0, big.value) +
            xlim(0,25) +
            theme_void() 
            #stat_summary(fun.y = max, colour = "red", geom = "point", size = 5)
            #ggsave(p, filename = paste0("fig2_", unique(.$SurveySet), ".png"), width = 8, height = 1.9)  # generate mini graph
            invisible(.) 
          })


```

# SUMMARY OF SABLEFISH BIOLOGICAL DATA `r yr+1`. {#app:nineth-appendix} 
Specimen counts of biological data collected for sablefish by set, including catch weight in kilograms and numbers of fish.  Details include a tally of specimens recovered, tagged and sampled.  Mean fork lengths for tagged sablefish and sampled male and female sablefish are listed.  Set numbers highlighted in grey indicate standardized sets at offshore indexing localities and set numbers highlighted in green indicate standardized sets at mainland inlet localities. All other sets are of the StRS type.


```{r appendixI, echo=FALSE}
   #  Sablefish.dbo.procReport_Survey_SampleDetails pulls data from table GFBIO_RESEARCH_SAMPLE_DETAILS built by     
   #  procedure Sablefish.dbo.Build_BIO_Sablefish_Tables 
  
   samples2       <-  paste("dbo.procReport_Survey_SampleDetails ", yr+1,",1,", setcnt2, sep="")
   #surveyspec2    <-  GetSQLData(samples2,"Sablefish")  # query SQL Server
   #write.table(surveyspec2, file = paste(path,"appendixI.csv",sep=''),row.names=FALSE, na="",col.names=TRUE, sep=",")
   surveyspec2       <-  read.csv(paste(path,'appendixI.csv',sep=''),header=T)
   count.row.total   <-  length(surveyspec2$SET)
   count.row         <-  length(surveyspec2$SET) - 1
   surveyspec2$SET[count.row.total] <- "Total"
  
   # add in sparkline 
   surveyspec2 <-  surveyspec2 %>%    
                  mutate(Sparkline = paste0("\\raisebox{.12\\height} {\\includegraphics[width=1.9cm]{fig2_",SET,".png}}") ) 
   
   surveyspec2  <- surveyspec2  %>%    
                   mutate(Survey.set= paste0("\\raisebox{-.28\\height} {\\includegraphics[width=0.8cm]{sets2_",SET,".png}}") ) 

   colnames(surveyspec2) <-  c("", "kg", "Count", "Recover-Rerelease", 
                              "Sampled", "Released", "Count",  
                              "Mean",     "Fork Length", "Sex", "Maturity", "Otoliths",
                              "Weight",   "Count", 
                              "Proportion Males", "Males", "Females")
 
   surveyspec2 <-  surveyspec2[, c(19, 2, 3, 18, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17)]  #reorder table
   
   colnames(surveyspec2) <- c("", "kg","Count","Count by Trap","Recover-Rerelease", "Deceased", "Released", 
                             "Count", "Mean", "Fork Length", "Sex","Maturity", "Otoliths",
                             "Weight","Count","Proportion Males", "Males", "Females" )
   
   kableExtra::kable(surveyspec2,
                     booktabs = TRUE,     
                     longtable = T,
                     escape = F,        # lets the image show up 
                     linesep   = "",
                     align=rep('r', 18),
                     format.args = list(big.mark = ','),  # add comma for big numbers
                     format = "latex") %>%
      
   add_header_above(c("Set"= 1,
                      "Total Catch" = 3, 
                      "Tagged Fish Counts" = 3,  
                      "Tagged Fork Lengths(mm)" = 2,
                      "Specimen Count"= 6, 
                      "Mean Fork Length(mm)" = 3), bold = TRUE) %>%
      
   kableExtra::kable_styling(font_size = 7.5, 
                     latex_options = "repeat_header",
                     repeat_header_text = "continued.", 
                     repeat_header_method = "replace") %>%     
   
   kableExtra::landscape()  %>%
   row_spec(0, bold = T)  %>%   
   column_spec(1,width    = "0.3cm") %>%  # set
   column_spec(2,width    = "0.6cm") %>%  # kg
   column_spec(3,width    = "0.7cm") %>%  # count
   column_spec(4,width    = "1.4cm") %>%  # sparkline      
   column_spec(5,width    = "0.9cm") %>%  # rr
   column_spec(6,width    = "1.0cm") %>%  # decease
   column_spec(7,width    = "0.9cm") %>%  # rel     
   column_spec(8,width    = "1.5cm") %>%  # count
   column_spec(9,width    = "0.9cm") %>%  # mean
   column_spec(10,width   = "0.7cm") %>%  # fl
   column_spec(11,width   = "0.6cm") %>%  # sex
   column_spec(12,width   = "0.7cm") %>%  # mat
   column_spec(13,width   = "0.7cm") %>%  # oto 
   column_spec(14,width   = "0.6cm") %>%  # wt
   column_spec(15,width   = "0.6cm") %>%  # cnt
   column_spec(16,width   = "1.1cm") %>%  # prop m
   column_spec(17,width   = "0.7cm") %>%  # male         
   column_spec(18,width   = "0.7cm") %>%  # fem
   row_spec(count.row.total, bold = T) %>%      
   row_spec(count.row,  hline_after = T)
```
\clearpage


# SUMMARY OF BIOLOGICAL DATA FOR OTHER SPECIES `r yr`. {#app:tenth-appendix} 
Details of biological data collected from species other than sablefish during the `r yr` survey.  The number of specimens taken for length and sex, proportion males and mean lengths are listed by species and set number.   
\ \
\ \

```{r appendixJ, echo=FALSE}
 
   other.samples <-  paste("select * from (SELECT species_name, [SET], morph_type, ",
                           "[Len Sample Count], [Sex Sample Count], Sample_count, ",
                           "[Proportion Males], ROUND([Male Mean Fork Len(mm)], 0) AS malelen, ",
                           "ROUND([Female Mean Fork Len(mm)], 0) AS femlen, round([NoSexMeanLen(mm)], 0) AS nosexlen ",
                           "from  dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH ",
                           "where (Year = ",yr,") ",
                           "and ([Len Sample Count] > 0) AND (morph_type = N'fork length') ",
                           "union  ",
                           "select species_name, [SET], morph_type, [Len Sample Count], [Sex Sample Count], ", 
                           "Sample_count, [Proportion Males], ROUND([Male Mean Total Len(mm)], 0) AS malelen, ",
                           "ROUND([Female Mean Total Len(mm)], 0) ",
                           "as femlen, ROUND([NoSexMeanLen(mm)], 0) AS nosexlen ",
                           "from dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH ",
                           "where (Year = ",yr,")  AND  ",
                           "([Len Sample Count] > 0) AND (morph_type = N'total length')  ",
                           "union  ",
                           "select species_name, [SET], morph_type, [Len Sample Count], [Sex Sample Count],   ",
                           "Sample_count, [Proportion Males], round([Male Mean Snout to to Anter. Edge Anal Fin Len(mm)], 0) AS malelen,  ",
                           "ROUND([Female Mean Snout to to Anter. Edge Anal Fin Len(mm)], 0)  AS femlen, ROUND([NoSexMeanLen(mm)], 0) AS nosexlen ",
                           "from dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH  ",
                           "where (Year = ",yr,")  AND  ",
                           "([Len Sample Count] > 0) AND (morph_type = N'SNOUT TO ANAL FIN LENGTH') ",
                           "union  ",
                           "select species_name, [SET], morph_type, [Len Sample Count], [Sex Sample Count], Sample_count,  ",
                           "[Proportion Males], ROUND([Male Precaudal Len(mm)], 0) AS malelen, ROUND([Female Precaudal Len(mm)], 0)  ",
                           "as femlen, ROUND([NoSexMeanLen(mm)], 0) AS nosexlen ",
                           "from dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH ",
                           "where  (Year = ",yr,")  ",
                           "and ([Len Sample Count] > 0) and (morph_type = N'PRE-CAUDAL LENGTH')) AS uniontable ",
                           "order by morph_type, species_name, [SET]", sep = "") 

   #  pre-caudal lengths and total lengths were taken for the tagged spiny dogfish and regular fish, 
   #  so include only length counts > 0

   #other.species            <-  GetSQLData(other.samples,"Sablefish")   # read from SQL Server
   #write.table(other.species, file = paste(path,'appendixJ.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")   
   other.species              <-  read.csv(paste(path,'appendixJ.csv',sep=''),header=T) # read from csv
   
   other.species$species_name <-  as.character(other.species$species_name)
   other.species$morph_type   <-  as.character(other.species$morph_type)
   row.count                <-  length(other.species$species_name)
  
   other.species$species_name  <-  cleanf(other.species$species_name)    # only represent name once
   other.species$morph_type    <-  cleanf(other.species$morph_type)
   other.species$species_name  <- gsub('GIANT GRENADIER', 'GIANT GRENADIER (PECTORAL RATTAIL)', other.species$species_name) 
   colnames(other.species)     <-  c( "Species Name", "Set", "Length Type",
                                      "Length", "Sex", "Total Count",
                                      "Proportion Males", "Males", "Females", "No sex")
  
   # updates based on original paper copy review to correct current numbers
   other.species[54,6] <- 8   # 54 REDBANDED ROCKFISH	  48	FORK LENGTH	8	8	7
   other.species[64,6] <- 22  # 64 REDBANDED ROCKFISH	  83	FORK LENGTH	22	22	18
   other.species[70,6] <- 2   # 70 REDBANDED ROCKFISH	  103	FORK LENGTH	2	2	1
   other.species[92,6] <- 3   # 92 ROUGHEYE/BLACKSPOTTED 26	FORK LENGTH	3	3	2
   other.species[96,6] <- 6   # 96 ROUGHEYE/BLACKSPOTTED 49	FORK LENGTH	6	6	5
   other.species[100,6]<- 72  # 100 ROUGHEYE/BLACKSPOTTED 80	FORK LENGTH	72	72	68
   other.species[104,6]<- 52  # 104 ROUGHEYE/BLACKSPOTTED 88	FORK LENGTH	52	52	51
   other.species[151,6]<- 19  # 151 GIANT GRENADIER	   2	TOTAL LENGTH	19	19	18
   other.species[160,6]<- 3   # 160 GIANT GRENADIER	  56	TOTAL LENGTH	3	3	2
   other.species[168,6]<- 47  # 168 PACIFIC GRENADIER	  2	TOTAL LENGTH	47	47	43
   other.species[185,6]<- 29  # 185 PACIFIC GRENADIER	  126	TOTAL LENGTH	29	29	28


   other.species[24,3]   <- "FORK LENGTH"
   other.species[25,3]   <- "FORK LENGTH"
   other.species[26,3]   <- "FORK LENGTH"
   other.species[28,3]   <- "FORK LENGTH"   
   other.species[29,3]   <- "FORK LENGTH" 
   other.species[40,3]   <- "FORK LENGTH"
   other.species[41,3]   <- "FORK LENGTH"   
   other.species[43,3]   <- "FORK LENGTH"   
   other.species[76,3]   <- "FORK LENGTH" 
   other.species[85,3]   <- "FORK LENGTH" 
   other.species[116,3]  <- "FORK LENGTH"   
   other.species[140,3]  <- "FORK LENGTH"    
   other.species[141,3]  <- "FORK LENGTH" 
   other.species[142,3]  <- "FORK LENGTH"   
   other.species[147,3]  <- "FORK LENGTH"
   
   other.species[149,3]  <- "TOTAL LENGTH" 
   other.species[151,3]  <- "TOTAL LENGTH" 
   other.species[168,3]  <- "TOTAL LENGTH"
   other.species[186,3]  <- "TOTAL LENGTH"
   

   kableExtra::kable(other.species,
                     booktabs = TRUE, 
                     longtable = T,
                     linesep   = "",
                     align=c('l','r','c','c','c','c','c','c','c','c'),
                     format = "latex") %>%
      
   add_header_above(c(" "= 3,
                      "Specimen Count"= 3, 
                      "Mean Length(mm)" = 4), bold=TRUE) %>%
   
   kableExtra::kable_styling(font_size = 7.5, 
                     latex_options = "repeat_header",
                     repeat_header_text = "continued.", 
                     repeat_header_method = "replace") %>%
                     column_spec(1,width     = "3.5cm") %>% # species
                     column_spec(2,width     = "0.5cm") %>% # set
                     column_spec(3,width     = "2.3cm") %>% # lentype 
                     column_spec(4,width     = "0.7cm") %>% # len   
                     column_spec(5,width     = "0.7cm") %>% # sex
                     column_spec(6,width     = "0.7cm") %>% # cnt
                     column_spec(7,width     = "1.1cm") %>% # 
                     column_spec(8,width     = "0.7cm") %>% # 
                     column_spec(9,width     = "0.7cm") %>% #         
                     column_spec(10,width    = "0.7cm") %>% # 
                     row_spec(0, bold = T) %>%
                     row_spec(c(23,24,25,27,28,39,40,42,75,84,115,139,140,141,146,147,148,150,167,185), hline_after = T)
   

```
\clearpage

# SUMMARY OF BIOLOGICAL DATA FOR OTHER SPECIES `r yr + 1`. {#app:eleventh-appendix} 
Details of biological data collected from species other than sablefish during the `r yr+1` survey.  The number of specimens taken for length and sex, proportion males and mean lengths are listed by species and set number.   
\ \

```{r appendixK, echo=FALSE}
 
   other.samples <-  paste("select * from (SELECT species_name, [SET], morph_type, ",
                           "[Len Sample Count], [Sex Sample Count], Sample_count, ",
                           "[Proportion Males], ",
                           "round([Male Mean Fork Len(mm)], 0) AS malelen, ",
                           "round([Female Mean Fork Len(mm)], 0) AS femlen, ",
                           "round([NoSexMeanLen(mm)], 0) AS nosexlen ",
                           "from dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH ",
                           "where (Year = ",yr+1,") ",
                           "AND ([Len Sample Count] > 0) AND (morph_type = N'fork length') ",
                           "union ",
                           "select species_name, [SET], morph_type, [Len Sample Count], [Sex Sample Count], Sample_count, ",
                           "[Proportion Males], ROUND([Male Mean Total Len(mm)], 0) AS malelen, ROUND([Female Mean Total Len(mm)], 0) ",
                           "AS femlen, ROUND([NoSexMeanLen(mm)], 0) AS nosexlen ",
                           "FROM  dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH ",
                           "where (Year = ",yr+1,")  AND ",
                           "([Len Sample Count] > 0) AND (morph_type = N'total length') ",
                           "union ",
                           "select species_name, [SET], morph_type, [Len Sample Count], [Sex Sample Count], ",
                           "Sample_count, [Proportion Males], ROUND([Male Mean Snout to to Anter. Edge Anal Fin Len(mm)], 0) AS malelen, ",
                           "round([Female Mean Snout to to Anter. Edge Anal Fin Len(mm)], 0)  AS femlen, ", 
                           "round([NoSexMeanLen(mm)], 0) AS nosexlen ",
                           "from dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH ",
                           "where (Year = ",yr+1,")  AND ",
                           "([Len Sample Count] > 0) AND (morph_type = N'SNOUT TO ANAL FIN LENGTH') ",
                           "union ",
                           "select species_name, [SET], morph_type, [Len Sample Count], [Sex Sample Count], ",
                           "Sample_count, [Proportion Males], ROUND([Male Precaudal Len(mm)], 0) AS malelen, ROUND([Female Precaudal Len(mm)], 0) ",
                           "AS femlen, ROUND([NoSexMeanLen(mm)], 0) AS nosexlen ",
                           "from  dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH ",
                           "where (Year = ",yr+1,") AND ",
                           "([Len Sample Count] > 0) AND (morph_type = N'PRE-CAUDAL LENGTH')) AS uniontable ",
                           "order by morph_type, species_name, [SET]", sep="") 
   #  pre-caudal lengths and total lengths were taken for the tagged spiny dogfish and regular fish, 
   #  so include only length counts > 0
   #other.species               <-  GetSQLData(other.samples,"Sablefish")   # read from SQL Server
   #write.table(other.species, file = paste(path,'appendixK.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")   
   other.species2              <-  read.csv(paste(path,'appendixK.csv',sep=''),header=T) # read from csv
   
   other.species2$species_name <-  as.character(other.species2$species_name)
   other.species2$morph_type   <-  as.character(other.species2$morph_type)
   row.count                   <-  length(other.species2$species_name)
  
   other.species2$species_name <-  cleanf(other.species2$species_name)    # only represent name once
   other.species2$morph_type   <-  cleanf(other.species2$morph_type)
   other.species2$species_name     <- gsub('GIANT GRENADIER', 'GIANT GRENADIER (PECTORAL RATTAIL)', other.species2$species_name) 

   colnames(other.species2)    <-  c( "Species Name", "Set", "Length Type",
                                      "Length", "Sex", "Total Count",
                                      "Proportion Males", "Males", "Females", "No sex")
   
   # updates based on paper copy review
   other.species2[23,6]  <- 49  # 23   ARROWTOOTH FLOUNDER	   79	FORK LENGTH	49	49	48
   other.species2[97,6]  <- 36  # 97   ROUGHEYE/BLACKSPOTTED	40	FORK LENGTH	36	36	31
   other.species2[106,6] <- 31  # 106  ROUGHEYE/BLACKSPOTTED  82	FORK LENGTH	31	31	29
   other.species2[121,6] <- 19  # 121  ROUGHEYE/BLACKSPOTTED 130	FORK LENGTH	19	19	17
   other.species2[127,6] <- 9   # 127  SHORTRAKER ROCKFISH	   52	FORK LENGTH	9	9	8
   other.species2[165,6] <- 10  # 165  PACIFIC SPINY DOGFISH	57	TOTAL LENGTH	10	10	5
   
   # a hack to make table look better
   other.species2[33,3]  <- "FORK LENGTH"
   other.species2[35,3]  <- "FORK LENGTH"
   other.species2[36,3]  <- "FORK LENGTH"   
   other.species2[37,3]  <- "FORK LENGTH"
   other.species2[38,3]  <- "FORK LENGTH"   
   other.species2[47,3]  <- "FORK LENGTH"
   other.species2[50,3]  <- "FORK LENGTH"
   other.species2[52,3]  <- "FORK LENGTH"  
   other.species2[82,3]  <- "FORK LENGTH"   
   other.species2[88,3]  <- "FORK LENGTH"
   other.species2[123,3] <- "FORK LENGTH" 
   other.species2[124,3] <- "FORK LENGTH" 
   other.species2[145,3] <- "FORK LENGTH"   
   other.species2[146,3] <- "FORK LENGTH" 
   
   other.species2[151,3] <- "TOTAL LENGTH"
   other.species2[154,3] <- "TOTAL LENGTH" 
   other.species2[170,3] <- "TOTAL LENGTH"
   other.species2[183,3] <- "TOTAL LENGTH"
   other.species2[184,3] <- "TOTAL LENGTH"
   
   kableExtra::kable(other.species2,
                     booktabs = TRUE, 
                     longtable = T,
                     linesep   = "",
                     align=c('l','r','c','c','c','c','c','c','c','c'),
                     format = "latex") %>%
      
   add_header_above(c(" "= 3,
                      "Specimen Count"= 3, 
                      "Mean Length(mm)" = 4), bold=TRUE) %>%
   
   kableExtra::kable_styling(font_size = 7.5, 
                     latex_options = "repeat_header",
                     repeat_header_text = "continued.", 
                     repeat_header_method = "replace") %>%
                     column_spec(1,width     = "3.7cm") %>% # species
                     column_spec(2,width     = "0.5cm") %>% # set
                     column_spec(3,width     = "2.3cm") %>% # lentype 
                     column_spec(4,width     = "0.7cm") %>% # len   
                     column_spec(5,width     = "0.7cm") %>% # sex
                     column_spec(6,width     = "0.7cm") %>% # cnt
                     column_spec(7,width     = "1.1cm") %>% # 
                     column_spec(8,width     = "0.7cm") %>% # 
                     column_spec(9,width     = "0.7cm") %>% #         
                     column_spec(10,width    = "0.7cm") %>% # 
                     row_spec(0, bold = T) %>%
                     row_spec(c(32,34,35,36,37,46,49,51,81,87,122,123,144,145,150,153,169,182,183), hline_after = T)

```
\clearpage


<!-- At the end of your appendices add: -->
`r if(knitr:::is_latex_output()) '% end csasdown appendix'`
